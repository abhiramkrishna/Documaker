<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DocuMaker - Business Document Suite</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Excel Export (SheetJS) -->
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>

    <!-- Word Export (docx) -->
    <script src="https://unpkg.com/docx@7.1.0/build/index.js"></script>

    <!-- File Saver -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <!-- Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        
        /* Hide scrollbar for sidebar but allow scroll */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        @media print {
            body { background: white; }
            .no-print { display: none !important; }
            .print-full { width: 100% !important; max-width: none !important; margin: 0 !important; padding: 0 !important; box-shadow: none !important; }
            input, textarea { border: none !important; background: transparent !important; resize: none; }
            /* Ensure colors print */
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 flex flex-col md:flex-row min-h-screen">

    <!-- SIDEBAR (Controls) -->
    <aside class="w-full md:w-80 bg-white border-r border-gray-200 p-6 flex flex-col gap-8 no-print h-auto md:h-screen md:sticky md:top-0 overflow-y-auto shadow-xl z-10">
        <div>
            <h1 class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-purple-600 mb-2">
                DocuMaker
            </h1>
            <p class="text-xs text-gray-500">Professional Business Suite</p>
        </div>

        <!-- Doc Type Selector -->
        <div class="grid grid-cols-2 gap-3" id="doc-type-container">
            <!-- Buttons injected by JS -->
        </div>

        <!-- Actions -->
        <div class="space-y-3">
            <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider">Output</h3>
            <button onclick="window.print()" class="w-full py-3 px-4 bg-gray-900 text-white rounded-xl flex items-center justify-center gap-2 hover:bg-gray-800 transition-colors shadow-lg active:transform active:scale-95">
                <i data-lucide="printer" class="w-4 h-4"></i>
                <span>Print / Save PDF</span>
            </button>
        </div>

        <!-- Export Options -->
        <div class="space-y-3">
            <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider">Save & Export</h3>
            
            <div class="grid grid-cols-2 gap-2">
                <!-- Native JSON -->
                <button onclick="exportData()" class="py-2 px-3 border border-gray-300 rounded-lg flex items-center justify-center gap-2 hover:bg-green-50 hover:text-green-700 hover:border-green-300 transition-colors text-xs font-medium">
                    <i data-lucide="code" class="w-3 h-3"></i> Save JSON
                </button>
                <button onclick="document.getElementById('import-input').click()" class="py-2 px-3 border border-gray-300 rounded-lg flex items-center justify-center gap-2 hover:bg-blue-50 hover:text-blue-700 hover:border-blue-300 transition-colors text-xs font-medium">
                    <i data-lucide="upload" class="w-3 h-3"></i> Load JSON
                    <input type="file" id="import-input" class="hidden" accept=".json" onchange="importData(this)">
                </button>
                
                <!-- Office Formats -->
                <button onclick="exportWord()" class="py-2 px-3 border border-gray-300 rounded-lg flex items-center justify-center gap-2 hover:bg-blue-600 hover:text-white hover:border-blue-600 transition-colors text-xs font-medium">
                    <i data-lucide="file-text" class="w-3 h-3"></i> Save Word
                </button>
                <button onclick="exportExcel()" class="py-2 px-3 border border-gray-300 rounded-lg flex items-center justify-center gap-2 hover:bg-green-600 hover:text-white hover:border-green-600 transition-colors text-xs font-medium">
                    <i data-lucide="sheet" class="w-3 h-3"></i> Save Excel
                </button>
            </div>

            <div class="flex gap-2 mt-2 pt-2 border-t border-gray-100">
                <button onclick="resetData()" class="flex-1 py-2 px-4 border border-gray-300 rounded-lg flex items-center justify-center gap-2 hover:bg-red-50 hover:text-red-600 hover:border-red-200 transition-colors text-sm">
                    <i data-lucide="refresh-ccw" class="w-4 h-4"></i> Reset
                </button>
                <label class="flex-1 py-2 px-4 border border-gray-300 rounded-lg flex items-center justify-center gap-2 hover:bg-gray-50 cursor-pointer transition-colors text-sm">
                    <i data-lucide="image" class="w-4 h-4"></i> Logo
                    <input type="file" class="hidden" accept="image/*" onchange="handleLogoUpload(this)">
                </label>
            </div>
        </div>

        <!-- Theme -->
        <div>
            <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3">Accent Color</h3>
            <div class="flex gap-3" id="theme-container">
                <!-- Theme buttons injected by JS -->
            </div>
        </div>

        <div class="mt-auto pt-6 border-t border-gray-100 text-xs text-gray-400 text-center">
            Designed for UAE VAT Compliance (5%)
        </div>
    </aside>

    <!-- MAIN WORKSPACE -->
    <main class="flex-1 p-4 md:p-8 overflow-x-hidden flex justify-center bg-gray-100 print:bg-white print:p-0">
        
        <!-- The A4 Page -->
        <div class="bg-white shadow-2xl w-full max-w-[210mm] min-h-[297mm] p-[10mm] md:p-[15mm] relative print-full print:p-0">
            
            <!-- Decorative Top Bar -->
            <div id="top-bar" class="absolute top-0 left-0 w-full h-2 bg-blue-600"></div>

            <!-- HEADER -->
            <header class="flex flex-col md:flex-row justify-between items-start mb-12 gap-6 mt-4">
                
                <!-- Company Info -->
                <div class="w-full md:w-1/2">
                    <div class="mb-4 group relative h-20 w-fit">
                        <div id="logo-placeholder" onclick="document.querySelector('input[type=file]').click()" class="h-20 w-20 bg-gray-100 rounded-lg border-2 border-dashed border-gray-300 flex items-center justify-center text-gray-400 cursor-pointer hover:bg-gray-50 hover:border-blue-400 transition-all no-print">
                            <i data-lucide="image" class="w-6 h-6"></i>
                        </div>
                        <div id="logo-container" class="relative hidden">
                            <img id="logo-img" src="" alt="Logo" class="h-20 w-auto object-contain">
                            <button onclick="removeLogo()" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1 opacity-0 group-hover:opacity-100 transition-opacity no-print">
                                <i data-lucide="trash-2" class="w-3 h-3"></i>
                            </button>
                        </div>
                    </div>

                    <input type="text" id="company-name" class="text-2xl font-bold text-gray-900 w-full placeholder-gray-300 focus:outline-none focus:bg-gray-50 rounded px-1 -ml-1 mb-1" placeholder="Your Company Name">
                    <textarea id="company-address" class="text-sm text-gray-500 w-full resize-none placeholder-gray-300 focus:outline-none focus:bg-gray-50 rounded px-1 -ml-1 h-16" placeholder="Your Address, PO Box, City"></textarea>
                    
                    <div class="flex items-center gap-2 mt-1">
                        <span class="text-xs font-bold text-gray-400 uppercase">TRN:</span>
                        <input id="company-trn" class="text-sm font-medium text-gray-700 w-40 focus:outline-none focus:bg-gray-50 rounded px-1" placeholder="100XXXXXXXXXX">
                    </div>
                </div>

                <!-- Doc Meta -->
                <div class="w-full md:w-1/3 text-right">
                    <h2 id="doc-label" class="text-4xl font-light text-blue-600 uppercase tracking-widest mb-4">Tax Invoice</h2>
                    
                    <div class="flex flex-col gap-2 items-end">
                        <div class="flex items-center gap-4">
                            <label class="text-sm font-semibold text-gray-500 uppercase">No:</label>
                            <input type="text" id="doc-number" class="text-right font-bold text-gray-800 focus:outline-none border-b border-transparent focus:border-blue-400 w-32" value="INV-001">
                        </div>
                        <div class="flex items-center gap-4">
                            <label class="text-sm font-semibold text-gray-500 uppercase">Date:</label>
                            <input type="date" id="doc-date" class="text-right font-medium text-gray-800 focus:outline-none bg-transparent w-32">
                        </div>
                        <div class="flex items-center gap-4" id="due-date-container">
                            <label class="text-sm font-semibold text-gray-500 uppercase">Due:</label>
                            <input type="date" id="doc-due-date" class="text-right font-medium text-gray-800 focus:outline-none bg-transparent w-32">
                        </div>
                    </div>
                </div>
            </header>

            <!-- BILL TO -->
            <section class="mb-10 bg-gray-50 rounded-lg p-6 border border-gray-100 print:border-gray-200 print:bg-transparent print:p-0">
                <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Bill To</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <input type="text" id="client-name" class="text-lg font-bold text-gray-900 w-full placeholder-gray-300 focus:outline-none bg-transparent" placeholder="Client Company Name">
                        <textarea id="client-address" class="text-sm text-gray-600 w-full resize-none placeholder-gray-300 focus:outline-none bg-transparent mt-1 h-12" placeholder="Client Address, City, Country"></textarea>
                    </div>
                    <div class="flex flex-col gap-2">
                        <div class="flex items-center gap-2">
                            <i data-lucide="user" class="w-3.5 h-3.5 text-gray-400"></i>
                            <input id="client-contact" class="text-sm text-gray-700 w-full focus:outline-none bg-transparent placeholder-gray-300" placeholder="Contact Person">
                        </div>
                        <div class="flex items-center gap-2">
                            <i data-lucide="building-2" class="w-3.5 h-3.5 text-gray-400"></i>
                            <span class="text-xs font-bold text-gray-400">TRN:</span>
                            <input id="client-trn" class="text-sm text-gray-700 w-full focus:outline-none bg-transparent placeholder-gray-300" placeholder="Client TRN (Optional)">
                        </div>
                    </div>
                </div>
            </section>

            <!-- ITEMS TABLE -->
            <section class="mb-10">
                <table class="w-full">
                    <thead>
                        <tr id="table-header-row" class="border-b-2 border-blue-600">
                            <th class="text-left py-3 px-2 text-xs font-bold text-gray-500 uppercase w-12">#</th>
                            <th class="text-left py-3 px-2 text-xs font-bold text-gray-500 uppercase">Description</th>
                            <th class="text-center py-3 px-2 text-xs font-bold text-gray-500 uppercase w-20">Qty</th>
                            <th class="price-col text-right py-3 px-2 text-xs font-bold text-gray-500 uppercase w-32">Rate (AED)</th>
                            <th class="price-col text-right py-3 px-2 text-xs font-bold text-gray-500 uppercase w-32">Total</th>
                            <th class="w-8 no-print"></th>
                        </tr>
                    </thead>
                    <tbody id="items-body">
                        <!-- Rows injected by JS -->
                    </tbody>
                </table>
                <button onclick="addItem()" class="mt-4 flex items-center gap-2 text-xs font-bold text-blue-600 hover:text-blue-700 transition-colors no-print">
                    <i data-lucide="plus" class="w-3.5 h-3.5"></i> Add Line Item
                </button>
            </section>

            <!-- TOTALS & NOTES -->
            <section class="flex flex-col md:flex-row gap-12">
                
                <!-- Notes -->
                <div class="flex-1 space-y-8">
                    <div>
                        <h4 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Terms & Notes</h4>
                        <textarea id="notes" class="w-full text-sm text-gray-600 resize-none focus:outline-none bg-transparent border-l-2 border-gray-200 pl-3 focus:border-blue-400 transition-colors" rows="3"></textarea>
                    </div>

                    <div id="bank-details-container">
                        <h4 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Bank Details</h4>
                        <textarea id="bank-details" class="w-full text-xs text-gray-500 font-mono resize-none focus:outline-none bg-gray-50 p-3 rounded" rows="4">Bank: Emirates NBD&#10;IBAN: AE0000000000000000&#10;Account Name: Your Company</textarea>
                    </div>
                </div>

                <!-- Calculations -->
                <div id="totals-box" class="w-full md:w-80">
                    <div class="bg-gray-50 rounded-lg p-6 space-y-3 print:bg-transparent print:p-0">
                        <div class="flex justify-between text-sm text-gray-600">
                            <span>Subtotal</span>
                            <span id="subtotal-display" class="font-medium">AED 0.00</span>
                        </div>
                        <div class="flex justify-between text-sm text-gray-600">
                            <span>VAT (5%)</span>
                            <span id="vat-display" class="font-medium">AED 0.00</span>
                        </div>
                        <div class="h-px w-full bg-gray-200 my-2"></div>
                        <div class="flex justify-between text-xl font-bold text-blue-700" id="total-text-container">
                            <span>Total</span>
                            <span id="total-display">AED 0.00</span>
                        </div>
                        <div class="text-right text-xs text-gray-400 mt-1">All prices in AED</div>
                    </div>
                </div>
            </section>

            <!-- FOOTER -->
            <footer class="mt-20 pt-8 border-t border-gray-100 flex flex-col items-center justify-center text-center gap-2">
                <h3 id="footer-company-name" class="text-lg font-bold text-gray-900">Your Company Name</h3>
                <p id="footer-contact" class="text-xs text-gray-500 max-w-md mx-auto"></p>
                <p class="text-[10px] text-gray-400 uppercase tracking-widest mt-4">Authorized Signature</p>
            </footer>

        </div>
    </main>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // --- Constants & Config ---
        const CURRENCY = 'AED';
        const VAT_RATE = 0.05;

        const COLOR_THEMES = {
            blue: { primary: 'bg-blue-600', text: 'text-blue-600', textDark: 'text-blue-700', border: 'border-blue-600', picker: 'bg-blue-500' },
            emerald: { primary: 'bg-emerald-600', text: 'text-emerald-600', textDark: 'text-emerald-700', border: 'border-emerald-600', picker: 'bg-emerald-500' },
            purple: { primary: 'bg-purple-600', text: 'text-purple-600', textDark: 'text-purple-700', border: 'border-purple-600', picker: 'bg-purple-500' },
            orange: { primary: 'bg-orange-600', text: 'text-orange-600', textDark: 'text-orange-700', border: 'border-orange-600', picker: 'bg-orange-500' },
            slate: { primary: 'bg-slate-800', text: 'text-slate-800', textDark: 'text-slate-900', border: 'border-slate-800', picker: 'bg-slate-800' },
            red: { primary: 'bg-red-600', text: 'text-red-600', textDark: 'text-red-700', border: 'border-red-600', picker: 'bg-red-500' }
        };

        const DOC_TYPES = {
            INVOICE: { label: 'Tax Invoice', icon: 'file-text', prefix: 'INV-', hasPrice: true, terms: 'Payment due within 30 days. Please include invoice number on your transfer.' },
            QUOTATION: { label: 'Quotation', icon: 'briefcase', prefix: 'QTN-', hasPrice: true, terms: 'This quotation is valid for 15 days. Subject to availability.' },
            LPO: { label: 'Purchase Order', icon: 'shopping-cart', prefix: 'PO-', hasPrice: true, terms: 'Please confirm receipt of this order. Deliver to the address mentioned above.' },
            DELIVERY: { label: 'Delivery Note', icon: 'truck', prefix: 'DN-', hasPrice: false, terms: 'Received the above goods in good condition.' }
        };

        // --- State ---
        let state = {
            activeDoc: 'INVOICE',
            docNumber: 'INV-001',
            date: new Date().toISOString().split('T')[0],
            dueDate: new Date().toISOString().split('T')[0],
            company: {
                name: 'Your Company Name',
                address: 'P.O. Box 12345, Dubai, UAE',
                trn: '100XXXXXXXXXXXX',
                logo: null
            },
            client: {
                name: 'Client Company LLC',
                address: 'Business Bay, Dubai, UAE',
                trn: '100YYYYYYYYYYYY',
                contact: 'Mr. John Doe'
            },
            items: [
                { id: 1, description: 'Consultation Services', qty: 5, rate: 250 },
                { id: 2, description: 'Software License (Annual)', qty: 1, rate: 1500 }
            ],
            notes: DOC_TYPES.INVOICE.terms,
            bankDetails: 'Bank: Emirates NBD\nIBAN: AE0000000000000000\nAccount Name: Your Company',
            accentColor: 'blue'
        };

        // --- Initialization ---
        function init() {
            renderDocTypeButtons();
            renderThemeButtons();
            bindInputs();
            updateUI();
            lucide.createIcons();
        }

        // --- Rendering & Logic ---

        function updateUI() {
            // Update Headers
            document.getElementById('doc-label').textContent = DOC_TYPES[state.activeDoc].label;
            document.getElementById('doc-number').value = state.docNumber;
            document.getElementById('doc-date').value = state.date;
            document.getElementById('doc-due-date').value = state.dueDate;
            document.getElementById('notes').value = state.notes;
            document.getElementById('bank-details').value = state.bankDetails;

            // Company & Client Inputs
            document.getElementById('company-name').value = state.company.name;
            document.getElementById('company-address').value = state.company.address;
            document.getElementById('company-trn').value = state.company.trn;
            document.getElementById('client-name').value = state.client.name;
            document.getElementById('client-address').value = state.client.address;
            document.getElementById('client-contact').value = state.client.contact;
            document.getElementById('client-trn').value = state.client.trn;

            // Footer
            document.getElementById('footer-company-name').textContent = state.company.name || 'Your Company';
            document.getElementById('footer-contact').textContent = `${state.company.address || ''}`;

            // Logo
            if (state.company.logo) {
                document.getElementById('logo-placeholder').classList.add('hidden');
                document.getElementById('logo-container').classList.remove('hidden');
                document.getElementById('logo-img').src = state.company.logo;
            } else {
                document.getElementById('logo-placeholder').classList.remove('hidden');
                document.getElementById('logo-container').classList.add('hidden');
            }

            // Visibility based on Doc Type
            const config = DOC_TYPES[state.activeDoc];
            
            // Toggle Price Columns
            const priceCols = document.querySelectorAll('.price-col');
            priceCols.forEach(el => el.style.display = config.hasPrice ? 'table-cell' : 'none');
            
            // Toggle Totals Box and Bank Details
            document.getElementById('totals-box').style.display = config.hasPrice ? 'block' : 'none';
            document.getElementById('bank-details-container').style.display = config.hasPrice ? 'block' : 'none';
            document.getElementById('due-date-container').style.display = state.activeDoc === 'INVOICE' ? 'flex' : 'none';

            // Theme Application
            applyTheme();

            renderItems();
            calculateTotals();
        }

        function applyTheme() {
            const theme = COLOR_THEMES[state.accentColor];
            
            // Top Bar
            document.getElementById('top-bar').className = `absolute top-0 left-0 w-full h-2 ${theme.primary}`;
            
            // Doc Label
            document.getElementById('doc-label').className = `text-4xl font-light ${theme.text} uppercase tracking-widest mb-4`;
            
            // Table Header Border
            document.getElementById('table-header-row').className = `border-b-2 ${theme.border}`;
            
            // Total Text
            document.getElementById('total-text-container').className = `flex justify-between text-xl font-bold ${theme.textDark}`;

            // Update Doc Type Buttons highlight
            renderDocTypeButtons();
            renderThemeButtons();
        }

        function renderItems() {
            const tbody = document.getElementById('items-body');
            tbody.innerHTML = '';
            const hasPrice = DOC_TYPES[state.activeDoc].hasPrice;

            state.items.forEach((item, index) => {
                const tr = document.createElement('tr');
                tr.className = 'group border-b border-gray-100 hover:bg-gray-50 transition-colors';
                
                let html = `
                    <td class="py-3 px-2 text-sm text-gray-500 align-top pt-4">${index + 1}</td>
                    <td class="py-2 px-2 align-top">
                        <textarea oninput="updateItem(${index}, 'description', this.value); autoResize(this)" class="w-full text-sm text-gray-800 font-medium focus:outline-none bg-transparent resize-none overflow-hidden" rows="1" placeholder="Item Description">${item.description}</textarea>
                    </td>
                    <td class="py-2 px-2 align-top">
                        <input type="number" oninput="updateItem(${index}, 'qty', this.value)" value="${item.qty}" class="w-full text-center text-sm text-gray-800 focus:outline-none bg-transparent">
                    </td>
                `;

                if (hasPrice) {
                    html += `
                        <td class="price-col py-2 px-2 align-top">
                            <input type="number" oninput="updateItem(${index}, 'rate', this.value)" value="${item.rate}" class="w-full text-right text-sm text-gray-800 focus:outline-none bg-transparent">
                        </td>
                        <td class="price-col py-3 px-2 text-right text-sm font-semibold text-gray-900 align-top pt-4">
                            ${formatCurrency(item.qty * item.rate)}
                        </td>
                    `;
                } else {
                    // Hidden placeholders to maintain structure if toggled back
                    html += `<td class="hidden price-col"></td><td class="hidden price-col"></td>`;
                }

                html += `
                    <td class="py-2 px-2 align-top text-center no-print">
                        <button onclick="deleteItem(${index})" class="text-gray-300 hover:text-red-500 transition-colors p-1">
                            <i data-lucide="trash-2" class="w-3.5 h-3.5"></i>
                        </button>
                    </td>
                `;

                tr.innerHTML = html;
                tbody.appendChild(tr);
            });
            
            // Re-initialize icons for new elements
            lucide.createIcons();
            
            // Auto resize textareas
            document.querySelectorAll('textarea').forEach(autoResize);
        }

        function calculateTotals() {
            if (!DOC_TYPES[state.activeDoc].hasPrice) return;

            const subtotal = state.items.reduce((acc, item) => acc + (item.qty * item.rate), 0);
            const vat = subtotal * VAT_RATE;
            const total = subtotal + vat;

            document.getElementById('subtotal-display').textContent = formatCurrency(subtotal);
            document.getElementById('vat-display').textContent = formatCurrency(vat);
            document.getElementById('total-display').textContent = formatCurrency(total);
        }

        // --- Event Handlers & Helpers ---

        function bindInputs() {
            // Bind simple inputs to state
            const mappings = {
                'doc-number': 'docNumber',
                'doc-date': 'date',
                'doc-due-date': 'dueDate',
                'notes': 'notes',
                'bank-details': 'bankDetails'
            };
            
            for (let [id, key] of Object.entries(mappings)) {
                document.getElementById(id).addEventListener('input', (e) => state[key] = e.target.value);
            }

            // Nested Objects
            const companyMappings = { 'company-name': 'name', 'company-address': 'address', 'company-trn': 'trn' };
            for (let [id, key] of Object.entries(companyMappings)) {
                document.getElementById(id).addEventListener('input', (e) => {
                    state.company[key] = e.target.value;
                    if(key === 'name' || key === 'address') updateUI(); // Update footer/header live
                });
            }

            const clientMappings = { 'client-name': 'name', 'client-address': 'address', 'client-contact': 'contact', 'client-trn': 'trn' };
            for (let [id, key] of Object.entries(clientMappings)) {
                document.getElementById(id).addEventListener('input', (e) => state.client[key] = e.target.value);
            }
        }

        function switchDocType(type) {
            state.activeDoc = type;
            state.docNumber = DOC_TYPES[type].prefix + '001';
            state.notes = DOC_TYPES[type].terms;
            updateUI();
        }

        function switchTheme(color) {
            state.accentColor = color;
            updateUI();
        }

        function updateItem(index, field, value) {
            if (field === 'qty' || field === 'rate') value = parseFloat(value) || 0;
            state.items[index][field] = value;
            if (field === 'qty' || field === 'rate') {
                updateUI(); // Full re-render needed to update row total text
            }
        }

        function addItem() {
            state.items.push({ id: Math.random().toString(36).substr(2, 9), description: '', qty: 1, rate: 0 });
            renderItems();
            calculateTotals();
        }

        function deleteItem(index) {
            state.items.splice(index, 1);
            renderItems();
            calculateTotals();
        }

        function handleLogoUpload(input) {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onloadend = () => {
                    state.company.logo = reader.result;
                    updateUI();
                };
                reader.readAsDataURL(file);
            }
        }

        function removeLogo() {
            state.company.logo = null;
            updateUI();
        }

        function autoResize(el) {
            el.style.height = 'auto';
            el.style.height = el.scrollHeight + 'px';
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-AE', {
                style: 'currency',
                currency: CURRENCY,
                minimumFractionDigits: 2
            }).format(amount);
        }

        // --- Generators ---

        function renderDocTypeButtons() {
            const container = document.getElementById('doc-type-container');
            container.innerHTML = '';
            
            for (const [key, type] of Object.entries(DOC_TYPES)) {
                const isActive = state.activeDoc === key;
                const btn = document.createElement('button');
                const activeClasses = `border-blue-500 bg-blue-50 text-blue-700 shadow-sm ring-1 ring-blue-500`;
                const inactiveClasses = `border-gray-200 hover:border-gray-300 hover:bg-gray-50`;
                
                btn.className = `p-3 rounded-xl border text-left transition-all duration-200 flex flex-col items-center justify-center gap-2 ${isActive ? activeClasses : inactiveClasses}`;
                btn.onclick = () => switchDocType(key);
                btn.innerHTML = `
                    <i data-lucide="${type.icon}" class="w-5 h-5"></i>
                    <span class="text-xs font-semibold">${type.label}</span>
                `;
                container.appendChild(btn);
            }
        }

        function renderThemeButtons() {
            const container = document.getElementById('theme-container');
            container.innerHTML = '';
            
            for (const [key, theme] of Object.entries(COLOR_THEMES)) {
                const isActive = state.accentColor === key;
                const btn = document.createElement('button');
                btn.className = `w-8 h-8 rounded-full border-2 transition-all flex items-center justify-center ${isActive ? 'border-gray-900 scale-110' : 'border-transparent'}`;
                btn.onclick = () => switchTheme(key);
                btn.innerHTML = `<div class="w-full h-full rounded-full ${theme.picker}"></div>`;
                container.appendChild(btn);
            }
        }

        // --- Data Persistence ---

        function exportData() {
            const blob = new Blob([JSON.stringify(state, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${state.docNumber || 'document'}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function importData(input) {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        state = { ...state, ...data };
                        updateUI();
                        alert('Document loaded successfully!');
                    } catch (err) {
                        alert('Invalid file format.');
                    }
                };
                reader.readAsText(file);
            }
            input.value = null; 
        }

        function resetData() {
            if(confirm('Reset all fields?')) {
                state.items = [{ id: 1, description: '', qty: 1, rate: 0 }];
                state.company.name = 'Your Company Name';
                state.company.address = 'Your Address';
                state.company.logo = null;
                state.client = { name: '', address: '', contact: '', trn: '' };
                updateUI();
            }
        }

        // --- EXPORT FUNCTIONS ---

        function exportExcel() {
            const ws_data = [];
            // Header
            ws_data.push([state.company.name]);
            ws_data.push([state.company.address]);
            ws_data.push([`TRN: ${state.company.trn}`]);
            ws_data.push([]);
            ws_data.push([DOC_TYPES[state.activeDoc].label, state.docNumber]);
            ws_data.push(["Date:", state.date]);
            ws_data.push(["Due Date:", state.dueDate]);
            ws_data.push([]);
            ws_data.push(["Bill To:"]);
            ws_data.push([state.client.name]);
            ws_data.push([state.client.address]);
            ws_data.push([`TRN: ${state.client.trn}`]);
            ws_data.push([]);

            // Table
            const headers = ["#", "Description", "Qty"];
            if(DOC_TYPES[state.activeDoc].hasPrice) {
                headers.push(`Rate (${CURRENCY})`, "Total");
            }
            ws_data.push(headers);

            state.items.forEach((item, i) => {
                const row = [i+1, item.description, item.qty];
                if(DOC_TYPES[state.activeDoc].hasPrice) {
                    row.push(item.rate, item.qty * item.rate);
                }
                ws_data.push(row);
            });

            ws_data.push([]);

            // Totals
            if(DOC_TYPES[state.activeDoc].hasPrice) {
                const sub = state.items.reduce((a,b)=>a+(b.qty*b.rate),0);
                ws_data.push(["", "", "", "Subtotal", sub]);
                ws_data.push(["", "", "", `VAT (${VAT_RATE*100}%)`, sub * VAT_RATE]);
                ws_data.push(["", "", "", "Total", sub * (1 + VAT_RATE)]);
            }

            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            XLSX.utils.book_append_sheet(wb, ws, "Document");
            XLSX.writeFile(wb, `${state.docNumber}.xlsx`);
        }

        function exportWord() {
            const { Document, Packer, Paragraph, Table, TableRow, TableCell, WidthType, TextRun, AlignmentType, BorderStyle } = docx;

            // Helper to create basic text cells
            const createCell = (text, width = 2000) => {
                return new TableCell({
                    width: { size: width, type: WidthType.DXA },
                    children: [new Paragraph(text)],
                });
            };

            // Calculate Totals
            const subtotal = state.items.reduce((a,b)=>a+(b.qty*b.rate),0);
            const vat = subtotal * VAT_RATE;
            const total = subtotal + vat;

            // Header Rows (Item Table)
            const tableRows = [
                new TableRow({
                    children: [
                        createCell("#", 500),
                        createCell("Description", 4000),
                        createCell("Qty", 1000),
                        createCell("Rate", 1500),
                        createCell("Total", 1500),
                    ],
                }),
            ];

            // Item Rows
            state.items.forEach((item, i) => {
                tableRows.push(
                    new TableRow({
                        children: [
                            createCell((i+1).toString(), 500),
                            createCell(item.description, 4000),
                            createCell(item.qty.toString(), 1000),
                            createCell(formatCurrency(item.rate), 1500),
                            createCell(formatCurrency(item.qty * item.rate), 1500),
                        ],
                    })
                );
            });

            // Create Doc
            const doc = new Document({
                sections: [{
                    properties: {},
                    children: [
                        new Paragraph({ children: [new TextRun({ text: state.company.name, bold: true, size: 32 })] }),
                        new Paragraph({ text: state.company.address }),
                        new Paragraph({ text: `TRN: ${state.company.trn}` }),
                        new Paragraph({ text: "" }), // spacer
                        new Paragraph({ children: [new TextRun({ text: DOC_TYPES[state.activeDoc].label, bold: true, size: 48, color: "2563EB" })], alignment: AlignmentType.RIGHT }),
                        new Paragraph({ text: `No: ${state.docNumber}`, alignment: AlignmentType.RIGHT }),
                        new Paragraph({ text: `Date: ${state.date}`, alignment: AlignmentType.RIGHT }),
                        new Paragraph({ text: "" }), // spacer
                        new Paragraph({ text: "Bill To:", bold: true }),
                        new Paragraph({ text: state.client.name }),
                        new Paragraph({ text: state.client.address }),
                        new Paragraph({ text: `TRN: ${state.client.trn}` }),
                        new Paragraph({ text: "" }), // spacer
                        new Table({
                            rows: tableRows,
                            width: { size: 100, type: WidthType.PERCENTAGE },
                        }),
                        new Paragraph({ text: "" }), // spacer
                        // Totals
                        new Paragraph({ text: `Subtotal: ${formatCurrency(subtotal)}`, alignment: AlignmentType.RIGHT }),
                        new Paragraph({ text: `VAT (5%): ${formatCurrency(vat)}`, alignment: AlignmentType.RIGHT }),
                        new Paragraph({ children: [new TextRun({ text: `Total: ${formatCurrency(total)}`, bold: true })], alignment: AlignmentType.RIGHT }),
                    ],
                }],
            });

            Packer.toBlob(doc).then((blob) => {
                saveAs(blob, `${state.docNumber}.docx`);
            });
        }

        // Start
        window.addEventListener('DOMContentLoaded', init);

    </script>
</body>
</html>
