<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DocuFlow</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Excel Export (SheetJS) -->
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>

    <!-- Word Export (docx) -->
    <script src="https://unpkg.com/docx@7.1.0/build/index.js"></script>

    <!-- File Saver -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <!-- Fonts (Expanded Collection) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Lato:wght@300;400;700&family=Montserrat:wght@300;400;500;600;700&family=Open+Sans:wght@300;400;600;700&family=Playfair+Display:wght@400;700&family=Poppins:wght@300;400;500;600;700&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        
        /* Hide scrollbar for sidebar but allow scroll */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        @media print {
            body { background: white; }
            .no-print { display: none !important; }
            .print-full { width: 100% !important; max-width: none !important; margin: 0 !important; padding: 0 !important; box-shadow: none !important; }
            input, textarea { border: none !important; background: transparent !important; resize: none; }
            /* Ensure colors print */
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
        }
        
        /* Modal Transitions */
        .modal { transition: opacity 0.3s ease-in-out; }
        .modal.hidden { opacity: 0; pointer-events: none; }
        .modal.flex { opacity: 1; pointer-events: auto; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 flex flex-col md:flex-row min-h-screen">

    <!-- LOGIN MODAL -->
    <div id="login-modal" class="modal hidden fixed inset-0 bg-black/50 z-50 items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-8 relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-blue-600 to-purple-600"></div>
            
            <div class="text-center mb-8">
                <h2 class="text-3xl font-bold text-gray-900 mb-2">Welcome Back</h2>
                <p class="text-gray-500">Sign in to save and sync your documents</p>
            </div>

            <div class="space-y-4">
                <button onclick="window.triggerAuth('google')" class="w-full py-3 px-4 border border-gray-200 rounded-xl flex items-center justify-center gap-3 hover:bg-gray-50 transition-colors group">
                    <img src="https://www.svgrepo.com/show/475656/google-color.svg" class="w-5 h-5 group-hover:scale-110 transition-transform" alt="Google">
                    <span class="font-medium text-gray-700">Continue with Google</span>
                </button>
                
                <button onclick="window.triggerAuth('github')" class="w-full py-3 px-4 border border-gray-200 rounded-xl flex items-center justify-center gap-3 hover:bg-gray-50 transition-colors group">
                    <img src="https://www.svgrepo.com/show/512317/github-142.svg" class="w-5 h-5 group-hover:scale-110 transition-transform" alt="GitHub">
                    <span class="font-medium text-gray-700">Continue with GitHub</span>
                </button>

                <div class="relative py-2">
                    <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-200"></div></div>
                    <div class="relative flex justify-center text-xs uppercase"><span class="bg-white px-2 text-gray-400">Or email</span></div>
                </div>

                <form onsubmit="event.preventDefault(); window.triggerAuth('email')" class="space-y-4">
                    <div>
                        <input type="email" placeholder="Email address" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none transition-all">
                    </div>
                    <div>
                        <input type="password" placeholder="Password" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none transition-all">
                    </div>
                    <button type="submit" class="w-full py-3 px-4 bg-gray-900 text-white rounded-xl font-medium hover:bg-gray-800 transition-colors shadow-lg shadow-gray-200">
                        Sign In
                    </button>
                </form>
            </div>
            <button onclick="toggleModal('login-modal')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><i data-lucide="x" class="w-5 h-5"></i></button>
        </div>
    </div>

    <!-- SAVED DOCS MODAL -->
    <div id="cloud-modal" class="modal hidden fixed inset-0 bg-black/50 z-50 items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl p-6 relative h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-900">Saved Documents</h2>
                <button onclick="toggleModal('cloud-modal')" class="text-gray-400 hover:text-gray-600"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <div id="cloud-list" class="flex-1 overflow-y-auto space-y-2 pr-2">
                <!-- Injected by JS -->
                <div class="text-center text-gray-400 py-10">Loading...</div>
            </div>
        </div>
    </div>

    <!-- SIDEBAR (Controls) -->
    <aside class="w-full md:w-80 bg-white border-r border-gray-200 p-6 flex flex-col gap-6 no-print h-auto md:h-screen md:sticky md:top-0 overflow-y-auto shadow-xl z-10 scrollbar-hide">
        <div>
            <div class="flex items-center gap-3 mb-1">
                <!-- Custom DF Logo -->
                <div class="w-10 h-10 flex-shrink-0 text-gray-800">
                    <svg viewBox="0 0 200 150" fill="none" xmlns="http://www.w3.org/2000/svg" class="w-full h-full">
                        <path d="M45 130C45 130 25 130 25 115C25 100 45 35 45 35C45 35 30 35 20 50M45 130C45 130 70 130 80 105C90 80 100 40 80 20C60 0 35 20 45 55C55 90 100 100 120 80" stroke="currentColor" stroke-width="14" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M120 80C140 60 160 30 140 20" stroke="currentColor" stroke-width="14" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M100 50 L 160 50" stroke="currentColor" stroke-width="14" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </div>
                <h1 class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-purple-600">
                    DocuFlow
                </h1>
            </div>
            
            <div class="flex items-center justify-between">
                <p class="text-xs text-gray-500 pl-1">Business Suite</p>
                <button id="auth-btn" onclick="toggleModal('login-modal')" class="text-xs font-semibold text-blue-600 hover:text-blue-700">Sign In</button>
            </div>
        </div>

        <!-- Template Selector -->
        <div>
            <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Design Template</h3>
            <div class="grid grid-cols-3 gap-2">
                <button onclick="setTemplate('classic')" class="template-btn p-2 border rounded-lg hover:bg-gray-50 text-xs font-medium text-center transition-all" data-template="classic">Classic</button>
                <button onclick="setTemplate('modern')" class="template-btn p-2 border rounded-lg hover:bg-gray-50 text-xs font-medium text-center transition-all" data-template="modern">Modern</button>
                <button onclick="setTemplate('minimal')" class="template-btn p-2 border rounded-lg hover:bg-gray-50 text-xs font-medium text-center transition-all" data-template="minimal">Minimal</button>
            </div>
        </div>

        <!-- Typography Selector -->
        <div>
            <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Typography</h3>
            <div class="relative">
                <select id="font-select" onchange="setFont(this.value)" class="w-full appearance-none p-2 pl-3 pr-8 border border-gray-200 rounded-lg text-xs font-medium bg-white focus:outline-none focus:border-blue-500 hover:bg-gray-50 transition-colors">
                    <!-- Options injected by JS -->
                </select>
                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-500">
                    <i data-lucide="chevron-down" class="w-4 h-4"></i>
                </div>
            </div>
        </div>

        <!-- Doc Type Selector -->
        <div class="grid grid-cols-2 gap-3" id="doc-type-container">
            <!-- Buttons injected by JS -->
        </div>

        <!-- Document Options -->
        <div>
            <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Options</h3>
            <label class="flex items-center gap-2 cursor-pointer p-3 border border-gray-200 rounded-xl hover:bg-gray-50 transition-colors bg-white shadow-sm">
                <div class="relative flex items-center">
                    <input type="checkbox" id="discount-toggle" onchange="toggleDiscount(this.checked)" class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500 border-gray-300">
                </div>
                <span class="text-xs font-medium text-gray-700 select-none">Enable Discount Field</span>
            </label>
        </div>

        <!-- Cloud Actions -->
        <div class="p-4 bg-blue-50 rounded-xl border border-blue-100 hidden" id="cloud-actions">
            <h3 class="text-xs font-bold text-blue-800 uppercase tracking-wider mb-2 flex items-center gap-2">
                <i data-lucide="cloud" class="w-3 h-3"></i> Cloud Sync
            </h3>
            <div class="flex gap-2">
                <button onclick="saveToCloud()" class="flex-1 py-2 bg-blue-600 text-white rounded-lg text-xs font-medium hover:bg-blue-700 transition-colors">Save</button>
                <button onclick="loadFromCloud()" class="flex-1 py-2 bg-white text-blue-600 border border-blue-200 rounded-lg text-xs font-medium hover:bg-blue-50 transition-colors">Load</button>
            </div>
        </div>

        <!-- Main Actions -->
        <div class="space-y-3">
            <button onclick="window.print()" class="w-full py-3 px-4 bg-gray-900 text-white rounded-xl flex items-center justify-center gap-2 hover:bg-gray-800 transition-colors shadow-lg active:transform active:scale-95">
                <i data-lucide="printer" class="w-4 h-4"></i>
                <span>Print / PDF</span>
            </button>
            
            <div class="grid grid-cols-2 gap-2">
                <button onclick="exportWord()" class="py-2 px-3 border border-gray-300 rounded-lg flex items-center justify-center gap-2 hover:bg-blue-600 hover:text-white hover:border-blue-600 transition-colors text-xs font-medium">
                    <i data-lucide="file-text" class="w-3 h-3"></i> Word
                </button>
                <button onclick="exportExcel()" class="py-2 px-3 border border-gray-300 rounded-lg flex items-center justify-center gap-2 hover:bg-green-600 hover:text-white hover:border-green-600 transition-colors text-xs font-medium">
                    <i data-lucide="sheet" class="w-3 h-3"></i> Excel
                </button>
            </div>
        </div>

        <!-- Utility -->
        <div class="flex gap-2 pt-2 border-t border-gray-100">
            <button onclick="resetData()" class="flex-1 py-2 px-4 border border-gray-300 rounded-lg flex items-center justify-center gap-2 hover:bg-red-50 hover:text-red-600 transition-colors text-sm">
                <i data-lucide="refresh-ccw" class="w-4 h-4"></i> Reset
            </button>
            <label class="flex-1 py-2 px-4 border border-gray-300 rounded-lg flex items-center justify-center gap-2 hover:bg-gray-50 cursor-pointer transition-colors text-sm">
                <i data-lucide="image" class="w-4 h-4"></i> Logo
                <input type="file" class="hidden" accept=".jpg, .jpeg, .png, .svg" onchange="handleLogoUpload(this)">
            </label>
        </div>

        <!-- Theme -->
        <div>
            <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3">Accent Color</h3>
            <div class="flex gap-3" id="theme-container"></div>
        </div>
    </aside>

    <!-- MAIN WORKSPACE -->
    <main class="flex-1 p-4 md:p-8 overflow-x-hidden flex justify-center bg-gray-100 print:bg-white print:p-0 transition-colors duration-300" id="main-bg">
        <!-- The Paper (Injected by JS based on template) -->
        <div id="paper-container" class="bg-white shadow-2xl w-full max-w-[210mm] min-h-[297mm] relative print-full print:p-0 transition-all duration-300">
            <!-- Template content goes here -->
        </div>
    </main>

    <!-- JAVASCRIPT LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, orderBy, doc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Configuration ---
        const CURRENCY = 'AED';
        const VAT_RATE = 0.05;

        const COLOR_THEMES = {
            blue: { primary: 'bg-blue-600', text: 'text-blue-600', textDark: 'text-blue-700', border: 'border-blue-600', picker: 'bg-blue-500', hex: '#2563eb' },
            emerald: { primary: 'bg-emerald-600', text: 'text-emerald-600', textDark: 'text-emerald-700', border: 'border-emerald-600', picker: 'bg-emerald-500', hex: '#059669' },
            purple: { primary: 'bg-purple-600', text: 'text-purple-600', textDark: 'text-purple-700', border: 'border-purple-600', picker: 'bg-purple-500', hex: '#7c3aed' },
            orange: { primary: 'bg-orange-600', text: 'text-orange-600', textDark: 'text-orange-700', border: 'border-orange-600', picker: 'bg-orange-500', hex: '#ea580c' },
            slate: { primary: 'bg-slate-800', text: 'text-slate-800', textDark: 'text-slate-900', border: 'border-slate-800', picker: 'bg-slate-800', hex: '#1e293b' },
            red: { primary: 'bg-red-600', text: 'text-red-600', textDark: 'text-red-700', border: 'border-red-600', picker: 'bg-red-500', hex: '#dc2626' }
        };

        const FONTS = {
            'Inter': "'Inter', sans-serif",
            'Poppins': "'Poppins', sans-serif",
            'Roboto': "'Roboto', sans-serif",
            'Open Sans': "'Open Sans', sans-serif",
            'Lato': "'Lato', sans-serif",
            'Montserrat': "'Montserrat', sans-serif",
            'Playfair Display': "'Playfair Display', serif"
        };

        const DOC_TYPES = {
            INVOICE: { label: 'Tax Invoice', icon: 'file-text', prefix: 'INV-', hasPrice: true, terms: 'Payment due within 30 days. Please include invoice number on your transfer.' },
            QUOTATION: { label: 'Quotation', icon: 'briefcase', prefix: 'QTN-', hasPrice: true, terms: 'This quotation is valid for 15 days. Subject to availability.' },
            LPO: { label: 'Purchase Order', icon: 'shopping-cart', prefix: 'PO-', hasPrice: true, terms: 'Please confirm receipt of this order. Deliver to the address mentioned above.' },
            DELIVERY: { label: 'Delivery Note', icon: 'truck', prefix: 'DN-', hasPrice: false, terms: 'Received the above goods in good condition.' }
        };

        // --- State ---
        let state = {
            template: 'classic', // classic, modern, minimal
            font: 'Inter',
            activeDoc: 'INVOICE',
            docNumber: 'INV-001',
            date: new Date().toISOString().split('T')[0],
            dueDate: new Date().toISOString().split('T')[0],
            company: { name: 'Your Company Name', address: 'P.O. Box 12345, Dubai, UAE', trn: '100XXXXXXXXXXXX', logo: null },
            client: { name: 'Client Company LLC', address: 'Business Bay, Dubai, UAE', trn: '100YYYYYYYYYYYY', contact: 'Mr. John Doe' },
            items: [
                { id: 1, description: 'Consultation Services', qty: 5, rate: 250 },
                { id: 2, description: 'Software License (Annual)', qty: 1, rate: 1500 }
            ],
            notes: DOC_TYPES.INVOICE.terms,
            bankDetails: 'Bank: Emirates NBD\nIBAN: AE0000000000000000\nAccount Name: Your Company',
            accentColor: 'blue',
            discount: 0,
            showDiscount: false
        };

        let currentUser = null;
        let db = null;
        let auth = null;
        let appId = 'docuflow-uae'; // Logical ID for Firestore path

        // --- Firebase Init ---
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        if (Object.keys(firebaseConfig).length > 0) {
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            appId = typeof __app_id !== 'undefined' ? __app_id : appId;

            onAuthStateChanged(auth, (user) => {
                currentUser = user;
                if (user) {
                    document.getElementById('auth-btn').textContent = 'Sign Out';
                    document.getElementById('auth-btn').onclick = () => signOut(auth);
                    document.getElementById('cloud-actions').classList.remove('hidden');
                    toggleModal('login-modal', false); // Close modal on success
                } else {
                    document.getElementById('auth-btn').textContent = 'Sign In';
                    document.getElementById('auth-btn').onclick = () => toggleModal('login-modal', true);
                    document.getElementById('cloud-actions').classList.add('hidden');
                }
            });
        }

        window.triggerAuth = async (provider) => {
            if (!auth) return;
            try {
                // In this environment, we use the provided token or anon auth
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Auth error", error);
                alert("Authentication failed. Please try again.");
            }
        };

        // --- Firestore Logic ---
        window.saveToCloud = async () => {
            if (!currentUser || !db) return;
            try {
                const docRef = await addDoc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'documents'), {
                    ...state,
                    savedAt: serverTimestamp(),
                    summary: `${state.client.name} - ${state.total || 0} ${CURRENCY}`
                });
                alert("Document saved securely to cloud!");
            } catch (e) {
                console.error("Error adding document: ", e);
                alert("Failed to save.");
            }
        };

        window.loadFromCloud = () => {
            if (!currentUser || !db) return;
            toggleModal('cloud-modal', true);
            const list = document.getElementById('cloud-list');
            list.innerHTML = '<div class="text-gray-400 text-center py-4">Loading...</div>';

            const q = query(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'documents'), orderBy('savedAt', 'desc'));
            onSnapshot(q, (snapshot) => {
                list.innerHTML = '';
                if (snapshot.empty) {
                    list.innerHTML = '<div class="text-gray-400 text-center py-4">No saved documents found.</div>';
                    return;
                }
                snapshot.forEach((docSnap) => {
                    const data = docSnap.data();
                    const div = document.createElement('div');
                    div.className = 'p-4 border rounded-lg hover:bg-gray-50 cursor-pointer flex justify-between items-center group transition-colors';
                    div.onclick = () => {
                        state = { ...state, ...data };
                        // Ensure optional fields are handled correctly if missing from older saved docs
                        if (typeof state.showDiscount === 'undefined') state.showDiscount = false;
                        if (typeof state.discount === 'undefined') state.discount = 0;
                        
                        // Remove timestamps causing issues
                        delete state.savedAt;
                        renderTemplate();
                        toggleModal('cloud-modal', false);
                    };
                    div.innerHTML = `
                        <div>
                            <div class="font-bold text-gray-800">${data.docNumber} - ${data.client.name}</div>
                            <div class="text-xs text-gray-500">${new Date(data.date).toLocaleDateString()} â€¢ ${DOC_TYPES[data.activeDoc]?.label}</div>
                        </div>
                        <div class="text-blue-600 opacity-0 group-hover:opacity-100 font-medium text-sm">Load</div>
                    `;
                    list.appendChild(div);
                });
            });
        };

        // --- Template Engine ---
        const TEMPLATES = {
            classic: () => {
                const theme = COLOR_THEMES[state.accentColor];
                const fontStyle = FONTS[state.font];
                return `
                    <div style="font-family: ${fontStyle}" class="p-[10mm] md:p-[15mm] h-full flex flex-col relative">
                        <div class="absolute top-0 left-0 w-full h-2 ${theme.primary}"></div>
                        <header class="flex flex-col md:flex-row justify-between items-start mb-8 mt-4 gap-6">
                            <div class="w-full md:w-1/2">
                                ${renderLogoPlaceholder()}
                                <input id="company-name" class="text-2xl font-bold text-gray-900 w-full placeholder-gray-300 focus:bg-gray-50 rounded -ml-1 mt-2" placeholder="Your Company" value="${state.company.name}">
                                <textarea id="company-address" class="text-sm text-gray-500 w-full resize-none placeholder-gray-300 focus:bg-gray-50 rounded -ml-1 h-16" placeholder="Address">${state.company.address}</textarea>
                                <div class="flex items-center gap-2 mt-1"><span class="text-xs font-bold text-gray-400 uppercase">TRN:</span><input id="company-trn" class="text-sm font-medium text-gray-700 w-40 focus:bg-gray-50 rounded" value="${state.company.trn}"></div>
                            </div>
                            <div class="w-full md:w-1/3 text-right">
                                <h2 class="text-4xl font-light ${theme.text} uppercase tracking-widest mb-4">${DOC_TYPES[state.activeDoc].label}</h2>
                                ${renderMetaFields()}
                            </div>
                        </header>
                        ${renderBillTo('bg-gray-50 rounded-lg p-6 border border-gray-100')}
                        ${renderTable(theme.border)}
                        <div class="mt-auto">${renderTotalsAndNotes()}</div>
                        ${renderFooter()}
                    </div>
                `;
            },
            modern: () => {
                const theme = COLOR_THEMES[state.accentColor];
                const fontStyle = FONTS[state.font];
                return `
                    <div style="font-family: ${fontStyle}" class="flex h-full min-h-[297mm]">
                        <div class="w-[70mm] ${theme.primary} text-white p-8 flex flex-col print:bg-gray-800 print:text-white">
                            <div class="mb-10 text-center">
                                ${state.company.logo ? `<img src="${state.company.logo}" class="h-24 w-auto object-contain mx-auto bg-white/10 rounded-lg p-2 mb-4">` : renderLogoPlaceholder('text-white/50 border-white/30 hover:bg-white/10')}
                            </div>
                            <div class="space-y-6">
                                <div>
                                    <h3 class="text-xs font-bold text-white/60 uppercase mb-2">From</h3>
                                    <input id="company-name" class="text-xl font-bold bg-transparent placeholder-white/50 w-full focus:outline-none" value="${state.company.name}">
                                    <textarea id="company-address" class="text-sm text-white/80 bg-transparent w-full resize-none h-20 focus:outline-none mt-1" placeholder="Address">${state.company.address}</textarea>
                                    <div class="flex gap-2 text-xs mt-2"><span class="text-white/60">TRN:</span><input id="company-trn" class="bg-transparent w-full focus:outline-none" value="${state.company.trn}"></div>
                                </div>
                                <div>
                                    <h3 class="text-xs font-bold text-white/60 uppercase mb-2">To</h3>
                                    <input id="client-name" class="font-bold bg-transparent placeholder-white/50 w-full focus:outline-none" value="${state.client.name}" placeholder="Client Name">
                                    <textarea id="client-address" class="text-sm text-white/80 bg-transparent w-full resize-none h-16 focus:outline-none mt-1" placeholder="Address">${state.client.address}</textarea>
                                </div>
                            </div>
                            <div class="mt-auto pt-8 border-t border-white/20">
                                <h2 class="text-2xl font-bold mb-2">${DOC_TYPES[state.activeDoc].label}</h2>
                                <div class="text-sm opacity-80 space-y-1">
                                    <div class="flex justify-between"><span>No:</span> <span>${state.docNumber}</span></div>
                                    <div class="flex justify-between"><span>Date:</span> <span>${state.date}</span></div>
                                </div>
                            </div>
                        </div>
                        <div class="flex-1 p-8 flex flex-col bg-white">
                            <!-- Hidden inputs for mapping logic to work, visual inputs are in sidebar -->
                            <div class="hidden">
                                <input id="doc-number" value="${state.docNumber}"><input id="doc-date" value="${state.date}"><input id="doc-due-date" value="${state.dueDate}">
                                <input id="client-contact" value="${state.client.contact}"><input id="client-trn" value="${state.client.trn}">
                            </div>
                            ${renderTable('border-gray-200', true)}
                            <div class="mt-8">${renderTotalsAndNotes(true)}</div>
                            <div class="mt-auto pt-8 border-t text-center text-xs text-gray-400">Authorized Signature</div>
                        </div>
                    </div>
                `;
            },
            minimal: () => {
                const theme = COLOR_THEMES[state.accentColor];
                const fontStyle = FONTS[state.font];
                return `
                    <div style="font-family: ${fontStyle}" class="p-[15mm] h-full flex flex-col">
                        <header class="text-center mb-16">
                            <div class="mb-6 flex justify-center">${state.company.logo ? `<img src="${state.company.logo}" class="h-16 w-auto">` : renderLogoPlaceholder()}</div>
                            <input id="company-name" class="text-3xl font-bold text-center w-full focus:outline-none" value="${state.company.name}">
                            <div class="flex justify-center gap-4 text-xs text-gray-500 mt-2 uppercase tracking-widest">
                                <input id="company-trn" class="text-center w-32 focus:outline-none" value="TRN: ${state.company.trn}">
                            </div>
                        </header>
                        <div class="flex justify-between items-end mb-12 pb-4 border-b border-gray-900">
                            <div>
                                <h3 class="text-xs font-bold uppercase tracking-widest mb-4">Invoiced To</h3>
                                <input id="client-name" class="font-bold text-lg w-full focus:outline-none" value="${state.client.name}">
                                <textarea id="client-address" class="text-sm w-full h-12 resize-none focus:outline-none" placeholder="Address">${state.client.address}</textarea>
                            </div>
                            <div class="text-right">
                                <h2 class="text-2xl font-bold mb-2">${DOC_TYPES[state.activeDoc].label}</h2>
                                ${renderMetaFields('text-right')}
                            </div>
                        </div>
                        ${renderTable('border-gray-900', false, 'text-sm')}
                        <div class="mt-12">${renderTotalsAndNotes()}</div>
                    </div>
                `;
            }
        };

        // --- Render Helpers ---
        function renderLogoPlaceholder(classes = "h-20 w-20 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300 flex items-center justify-center text-gray-400 cursor-pointer hover:border-blue-400") {
            if (state.company.logo) return `<div class="relative group inline-block"><img src="${state.company.logo}" class="h-20 w-auto object-contain"><button onclick="window.removeLogo()" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1 opacity-0 group-hover:opacity-100 no-print"><i data-lucide="trash-2" class="w-3 h-3"></i></button></div>`;
            return `<div onclick="document.querySelector('input[type=file]').click()" class="${classes} no-print"><i data-lucide="image" class="w-6 h-6"></i></div>`;
        }

        function renderMetaFields(align = 'items-end') {
            return `
                <div class="flex flex-col gap-2 ${align}">
                    <div class="flex items-center gap-4 justify-end"><label class="text-xs font-bold text-gray-400 uppercase">No:</label><input id="doc-number" class="text-right font-bold text-gray-800 w-32 focus:outline-none" value="${state.docNumber}"></div>
                    <div class="flex items-center gap-4 justify-end"><label class="text-xs font-bold text-gray-400 uppercase">Date:</label><input type="date" id="doc-date" class="text-right font-medium text-gray-800 bg-transparent w-32 focus:outline-none" value="${state.date}"></div>
                    ${state.activeDoc === 'INVOICE' ? `<div class="flex items-center gap-4 justify-end"><label class="text-xs font-bold text-gray-400 uppercase">Due:</label><input type="date" id="doc-due-date" class="text-right font-medium text-gray-800 bg-transparent w-32 focus:outline-none" value="${state.dueDate}"></div>` : ''}
                </div>
            `;
        }

        function renderBillTo(classes) {
            return `
                <section class="mb-10 ${classes}">
                    <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Bill To</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <input id="client-name" class="text-lg font-bold text-gray-900 w-full bg-transparent focus:outline-none" value="${state.client.name}">
                            <textarea id="client-address" class="text-sm text-gray-600 w-full resize-none bg-transparent mt-1 h-12 focus:outline-none">${state.client.address}</textarea>
                        </div>
                        <div class="flex flex-col gap-2">
                            <div class="flex items-center gap-2"><i data-lucide="user" class="w-3.5 h-3.5 text-gray-400"></i><input id="client-contact" class="text-sm text-gray-700 w-full bg-transparent focus:outline-none" value="${state.client.contact}" placeholder="Contact Person"></div>
                            <div class="flex items-center gap-2"><i data-lucide="building-2" class="w-3.5 h-3.5 text-gray-400"></i><span class="text-xs font-bold text-gray-400">TRN:</span><input id="client-trn" class="text-sm text-gray-700 w-full bg-transparent focus:outline-none" value="${state.client.trn}" placeholder="Client TRN"></div>
                        </div>
                    </div>
                </section>
            `;
        }

        function renderTable(borderColor, modern = false, font = '') {
            const hasPrice = DOC_TYPES[state.activeDoc].hasPrice;
            const rows = state.items.map((item, i) => `
                <tr class="group border-b border-gray-100 hover:bg-gray-50 transition-colors">
                    <td class="py-3 px-2 text-sm text-gray-500 align-top pt-4 ${font}">${i + 1}</td>
                    <td class="py-2 px-2 align-top"><textarea oninput="window.updateItem(${i}, 'description', this.value)" class="w-full text-sm text-gray-800 font-medium bg-transparent resize-none overflow-hidden focus:outline-none ${font}" rows="1">${item.description}</textarea></td>
                    <td class="py-2 px-2 align-top"><input type="number" oninput="window.updateItem(${i}, 'qty', this.value)" value="${item.qty}" class="w-full text-center text-sm text-gray-800 bg-transparent focus:outline-none ${font}"></td>
                    ${hasPrice ? `
                        <td class="py-2 px-2 align-top"><input type="number" oninput="window.updateItem(${i}, 'rate', this.value)" value="${item.rate}" class="w-full text-right text-sm text-gray-800 bg-transparent focus:outline-none ${font}"></td>
                        <td class="py-3 px-2 text-right text-sm font-semibold text-gray-900 align-top pt-4 ${font}">${formatCurrency(item.qty * item.rate)}</td>
                    ` : ''}
                    <td class="py-2 px-2 align-top text-center no-print"><button onclick="window.deleteItem(${i})" class="text-gray-300 hover:text-red-500 p-1"><i data-lucide="trash-2" class="w-3.5 h-3.5"></i></button></td>
                </tr>
            `).join('');

            return `
                <section class="mb-10">
                    <table class="w-full">
                        <thead>
                            <tr class="border-b-2 ${borderColor}">
                                <th class="text-left py-3 px-2 text-xs font-bold text-gray-500 uppercase w-12">#</th>
                                <th class="text-left py-3 px-2 text-xs font-bold text-gray-500 uppercase">Description</th>
                                <th class="text-center py-3 px-2 text-xs font-bold text-gray-500 uppercase w-20">Qty</th>
                                ${hasPrice ? `<th class="text-right py-3 px-2 text-xs font-bold text-gray-500 uppercase w-32">Rate</th><th class="text-right py-3 px-2 text-xs font-bold text-gray-500 uppercase w-32">Total</th>` : ''}
                                <th class="w-8 no-print"></th>
                            </tr>
                        </thead>
                        <tbody>${rows}</tbody>
                    </table>
                    <button onclick="window.addItem()" class="mt-4 flex items-center gap-2 text-xs font-bold text-blue-600 hover:text-blue-700 transition-colors no-print"><i data-lucide="plus" class="w-3.5 h-3.5"></i> Add Line Item</button>
                </section>
            `;
        }

        function renderTotalsAndNotes(vertical = false) {
            const hasPrice = DOC_TYPES[state.activeDoc].hasPrice;
            const theme = COLOR_THEMES[state.accentColor];
            const subtotal = state.items.reduce((acc, item) => acc + (item.qty * item.rate), 0);
            
            // Discount Logic
            const discount = state.showDiscount ? (parseFloat(state.discount) || 0) : 0;
            const taxable = Math.max(0, subtotal - discount);
            const vat = taxable * VAT_RATE;
            const total = taxable + vat;
            state.total = total;

            const notesSection = `
                <div class="flex-1 space-y-8">
                    <div><h4 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Terms</h4><textarea id="notes" class="w-full text-sm text-gray-600 resize-none bg-transparent border-l-2 border-gray-200 pl-3 focus:outline-none" rows="3">${state.notes}</textarea></div>
                    ${hasPrice ? `<div><h4 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Bank Details</h4><textarea id="bank-details" class="w-full text-xs text-gray-500 font-mono resize-none bg-gray-50 p-3 rounded focus:outline-none" rows="4">${state.bankDetails}</textarea></div>` : ''}
                </div>
            `;

            const discountRow = state.showDiscount ? `
                <div class="flex justify-between items-center text-sm text-gray-600">
                    <span>Discount</span>
                    <div class="flex items-center w-24 border-b border-gray-200 focus-within:border-blue-500">
                        <input type="number" oninput="window.updateDiscount(this.value)" value="${state.discount}" class="w-full text-right bg-transparent focus:outline-none text-sm" placeholder="0">
                    </div>
                </div>` : '';

            const totalsSection = hasPrice ? `
                <div class="${vertical ? 'w-full' : 'w-full md:w-80'}">
                    <div class="bg-gray-50 rounded-lg p-6 space-y-3 print:bg-transparent print:p-0">
                        <div class="flex justify-between text-sm text-gray-600"><span>Subtotal</span><span class="font-medium">${formatCurrency(subtotal)}</span></div>
                        ${discountRow}
                        <div class="flex justify-between text-sm text-gray-600"><span>VAT (5%)</span><span class="font-medium" id="val-vat">${formatCurrency(vat)}</span></div>
                        <div class="h-px w-full bg-gray-200 my-2"></div>
                        <div class="flex justify-between text-xl font-bold ${theme.textDark}"><span>Total</span><span id="val-total">${formatCurrency(total)}</span></div>
                        <div class="text-right text-xs text-gray-400 mt-1">AED</div>
                    </div>
                </div>
            ` : '';

            return `<section class="flex flex-col ${vertical ? 'gap-8' : 'md:flex-row gap-12'}">${notesSection}${totalsSection}</section>`;
        }

        function renderFooter() {
            return `
                <footer class="mt-20 pt-8 border-t border-gray-100 flex flex-col items-center justify-center text-center gap-2">
                    <h3 class="text-lg font-bold text-gray-900">${state.company.name}</h3>
                    <p class="text-xs text-gray-500 max-w-md mx-auto">${state.company.address}</p>
                    <p class="text-[10px] text-gray-400 uppercase tracking-widest mt-4">Authorized Signature</p>
                </footer>
            `;
        }

        // --- Main Logic ---

        window.renderTemplate = () => {
            const html = TEMPLATES[state.template]();
            document.getElementById('paper-container').innerHTML = html;
            
            // Re-bind listeners
            bindInputs();
            lucide.createIcons();
            document.querySelectorAll('textarea').forEach(el => {
                el.style.height = 'auto';
                el.style.height = el.scrollHeight + 'px';
            });

            // Update Active Buttons & Controls
            document.querySelectorAll('.template-btn').forEach(btn => {
                if(btn.dataset.template === state.template) {
                    btn.className = "template-btn p-2 border border-blue-500 bg-blue-50 text-blue-700 rounded-lg text-xs font-medium text-center shadow-sm";
                } else {
                    btn.className = "template-btn p-2 border border-gray-200 hover:bg-gray-50 rounded-lg text-xs font-medium text-center text-gray-600";
                }
            });
            
            document.getElementById('font-select').value = state.font;
            
            // Sync Discount Toggle
            const discToggle = document.getElementById('discount-toggle');
            if (discToggle) discToggle.checked = state.showDiscount;
        };

        window.setTemplate = (tmpl) => {
            state.template = tmpl;
            window.renderTemplate();
        };

        window.setFont = (fontName) => {
            state.font = fontName;
            window.renderTemplate();
        };

        window.toggleDiscount = (checked) => {
            state.showDiscount = checked;
            window.renderTemplate();
        };

        function bindInputs() {
            const bindings = [
                { id: 'company-name', path: ['company', 'name'] },
                { id: 'company-address', path: ['company', 'address'] },
                { id: 'company-trn', path: ['company', 'trn'] },
                { id: 'client-name', path: ['client', 'name'] },
                { id: 'client-address', path: ['client', 'address'] },
                { id: 'client-contact', path: ['client', 'contact'] },
                { id: 'client-trn', path: ['client', 'trn'] },
                { id: 'doc-number', path: ['docNumber'] },
                { id: 'doc-date', path: ['date'] },
                { id: 'doc-due-date', path: ['dueDate'] },
                { id: 'notes', path: ['notes'] },
                { id: 'bank-details', path: ['bankDetails'] }
            ];

            bindings.forEach(({ id, path }) => {
                const el = document.getElementById(id);
                if (el) {
                    el.addEventListener('input', (e) => {
                        if (path.length === 2) state[path[0]][path[1]] = e.target.value;
                        else state[path[0]] = e.target.value;
                    });
                }
            });
        }

        // --- Helpers ---
        window.addItem = () => {
            state.items.push({ id: Math.random().toString(36).substr(2, 9), description: '', qty: 1, rate: 0 });
            window.renderTemplate();
        };

        window.deleteItem = (index) => {
            state.items.splice(index, 1);
            window.renderTemplate();
        };

        window.updateItem = (index, field, value) => {
            if (field === 'qty' || field === 'rate') value = parseFloat(value) || 0;
            state.items[index][field] = value;
            if(field === 'qty' || field === 'rate') window.renderTemplate(); 
        };

        window.updateDiscount = (val) => {
            state.discount = parseFloat(val) || 0;
            // Immediate update of totals without full re-render
            const subtotal = state.items.reduce((acc, item) => acc + (item.qty * item.rate), 0);
            const taxable = Math.max(0, subtotal - state.discount);
            const vat = taxable * VAT_RATE;
            const total = taxable + vat;
            
            const elVat = document.getElementById('val-vat');
            const elTotal = document.getElementById('val-total');
            if(elVat) elVat.innerText = formatCurrency(vat);
            if(elTotal) elTotal.innerText = formatCurrency(total);
        };

        window.handleLogoUpload = (input) => {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onloadend = () => {
                    state.company.logo = reader.result;
                    window.renderTemplate();
                };
                reader.readAsDataURL(file);
            }
        };

        window.removeLogo = () => {
            state.company.logo = null;
            window.renderTemplate();
        };

        window.resetData = () => {
            if(confirm('Reset all fields?')) {
                state.items = [{ id: 1, description: '', qty: 1, rate: 0 }];
                state.company = { name: 'Your Company', address: 'Address', trn: '', logo: null };
                state.client = { name: 'Client', address: '', contact: '', trn: '' };
                state.discount = 0;
                state.showDiscount = false;
                window.renderTemplate();
            }
        };

        window.toggleModal = (id, show) => {
            const el = document.getElementById(id);
            if (typeof show === 'undefined') {
                el.classList.toggle('hidden');
                el.classList.toggle('flex');
            } else if (show) {
                el.classList.remove('hidden');
                el.classList.add('flex');
            } else {
                el.classList.add('hidden');
                el.classList.remove('flex');
            }
        };

        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-AE', { style: 'currency', currency: CURRENCY }).format(amount);
        }

        // --- Init ---
        // Render Doc Type Buttons
        const container = document.getElementById('doc-type-container');
        for (const [key, type] of Object.entries(DOC_TYPES)) {
            const btn = document.createElement('button');
            btn.className = `p-3 rounded-xl border text-left transition-all flex flex-col items-center justify-center gap-2 hover:bg-gray-50`;
            btn.innerHTML = `<i data-lucide="${type.icon}" class="w-5 h-5"></i><span class="text-xs font-semibold">${type.label}</span>`;
            btn.onclick = () => {
                state.activeDoc = key;
                state.docNumber = type.prefix + '001';
                state.notes = type.terms;
                window.renderTemplate();
            };
            container.appendChild(btn);
        }

        // Render Themes
        const themeContainer = document.getElementById('theme-container');
        for (const [key, theme] of Object.entries(COLOR_THEMES)) {
            const btn = document.createElement('button');
            btn.className = `w-8 h-8 rounded-full border-2 transition-all flex items-center justify-center border-transparent`;
            btn.innerHTML = `<div class="w-full h-full rounded-full ${theme.picker}"></div>`;
            btn.onclick = () => {
                state.accentColor = key;
                window.renderTemplate();
            };
            themeContainer.appendChild(btn);
        }
        
        // Render Font Options
        const fontSelect = document.getElementById('font-select');
        for (const fontName of Object.keys(FONTS)) {
            const option = document.createElement('option');
            option.value = fontName;
            option.textContent = fontName;
            fontSelect.appendChild(option);
        }

        window.renderTemplate();
        
        // --- Export Functions ---
        window.exportExcel = () => {
             const ws_data = [];
            // Header
            ws_data.push([state.company.name]);
            ws_data.push([state.company.address]);
            ws_data.push([`TRN: ${state.company.trn}`]);
            ws_data.push([]);
            ws_data.push([DOC_TYPES[state.activeDoc].label, state.docNumber]);
            ws_data.push(["Date:", state.date]);
            ws_data.push(["Due Date:", state.dueDate]);
            ws_data.push([]);
            ws_data.push(["Bill To:"]);
            ws_data.push([state.client.name]);
            ws_data.push([state.client.address]);
            ws_data.push([`TRN: ${state.client.trn}`]);
            ws_data.push([]);

            // Table
            const headers = ["#", "Description", "Qty"];
            if(DOC_TYPES[state.activeDoc].hasPrice) {
                headers.push(`Rate (${CURRENCY})`, "Total");
            }
            ws_data.push(headers);

            state.items.forEach((item, i) => {
                const row = [i+1, item.description, item.qty];
                if(DOC_TYPES[state.activeDoc].hasPrice) {
                    row.push(item.rate, item.qty * item.rate);
                }
                ws_data.push(row);
            });

            ws_data.push([]);

            // Totals
            if(DOC_TYPES[state.activeDoc].hasPrice) {
                const sub = state.items.reduce((a,b)=>a+(b.qty*b.rate),0);
                ws_data.push(["", "", "", "Subtotal", sub]);
                
                let taxable = sub;
                if(state.showDiscount) {
                    const discount = parseFloat(state.discount) || 0;
                    taxable = Math.max(0, sub - discount);
                    ws_data.push(["", "", "", "Discount", discount]);
                }
                
                const vat = taxable * VAT_RATE;
                ws_data.push(["", "", "", `VAT (${VAT_RATE*100}%)`, vat]);
                ws_data.push(["", "", "", "Total", taxable + vat]);
            }

            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            XLSX.utils.book_append_sheet(wb, ws, "Document");
            XLSX.writeFile(wb, `${state.docNumber}.xlsx`);
        };

        window.exportWord = () => {
            const { Document, Packer, Paragraph, Table, TableRow, TableCell, WidthType, TextRun, AlignmentType, BorderStyle } = docx;

            const createCell = (text, width = 2000) => new TableCell({ width: { size: width, type: WidthType.DXA }, children: [new Paragraph(text)] });
            
            const subtotal = state.items.reduce((a,b)=>a+(b.qty*b.rate),0);
            const discount = state.showDiscount ? (parseFloat(state.discount) || 0) : 0;
            const taxable = Math.max(0, subtotal - discount);
            const vat = taxable * VAT_RATE;
            const total = taxable + vat;

            const tableRows = [new TableRow({ children: [createCell("#", 500), createCell("Description", 4000), createCell("Qty", 1000), createCell("Rate", 1500), createCell("Total", 1500)] })];
            state.items.forEach((item, i) => {
                tableRows.push(new TableRow({ children: [createCell((i+1).toString(), 500), createCell(item.description, 4000), createCell(item.qty.toString(), 1000), createCell(formatCurrency(item.rate), 1500), createCell(formatCurrency(item.qty * item.rate), 1500)] }));
            });

            const children = [
                new Paragraph({ children: [new TextRun({ text: state.company.name, bold: true, size: 32 })] }),
                new Paragraph({ text: state.company.address }),
                new Paragraph({ text: `TRN: ${state.company.trn}` }),
                new Paragraph({ text: "" }),
                new Paragraph({ children: [new TextRun({ text: DOC_TYPES[state.activeDoc].label, bold: true, size: 48, color: "2563EB" })], alignment: AlignmentType.RIGHT }),
                new Paragraph({ text: `No: ${state.docNumber}`, alignment: AlignmentType.RIGHT }),
                new Paragraph({ text: `Date: ${state.date}`, alignment: AlignmentType.RIGHT }),
                new Paragraph({ text: "" }),
                new Paragraph({ text: "Bill To:", bold: true }),
                new Paragraph({ text: state.client.name }),
                new Paragraph({ text: state.client.address }),
                new Table({ rows: tableRows, width: { size: 100, type: WidthType.PERCENTAGE } }),
                new Paragraph({ text: "" }),
                new Paragraph({ text: `Subtotal: ${formatCurrency(subtotal)}`, alignment: AlignmentType.RIGHT })
            ];

            if(state.showDiscount) {
                children.push(new Paragraph({ text: `Discount: ${formatCurrency(discount)}`, alignment: AlignmentType.RIGHT }));
            }

            children.push(new Paragraph({ text: `VAT (5%): ${formatCurrency(vat)}`, alignment: AlignmentType.RIGHT }));
            children.push(new Paragraph({ children: [new TextRun({ text: `Total: ${formatCurrency(total)}`, bold: true })], alignment: AlignmentType.RIGHT }));

            const doc = new Document({
                sections: [{
                    properties: {},
                    children: children,
                }],
            });

            Packer.toBlob(doc).then((blob) => { saveAs(blob, `${state.docNumber}.docx`); });
        };
    </script>
</body>
</html>
